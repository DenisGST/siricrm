<!-- –®–∞–ø–∫–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–ª–∏–µ–Ω—Ç–µ -->
<div class="px-4 py-3 border-b border-base-200 flex items-center gap-3">
  <div class="avatar placeholder">
    <div class="w-8 rounded-full bg-secondary text-secondary-content text-xs">
      {{ client.first_name|first|default:"–ö" }}
    </div>
  </div>
  <div class="flex flex-col">
    <span class="font-medium text-sm">
      {{ client.first_name }}{% if client.last_name %} {{ client.last_name }}{% endif %}
    </span>
    <span class="text-xs text-base-content/60">
      {% if client.username %}@{{ client.username }}{% endif %}
      {% if client.phone %} ‚Ä¢ {{ client.phone }}{% endif %}
    </span>
  </div>
</div>

<!-- –õ–µ–Ω—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π -->
<div
  id="telegram-chat-messages"
  class="flex-1 overflow-y-auto px-4 py-3 space-y-3 bg-base-100"
  style="max-height: calc(80vh - 140px);"
>
  {% for msg in messages %}
    {% if msg.direction == "incoming" %}
      <div class="chat chat-start">
    {% else %}
      <div class="chat chat-end">
    {% endif %}

        <div class="chat-bubble
                    {% if msg.direction == 'incoming' %}
                      bg-emerald-50 text-emerald-900
                    {% else %}
                      chat-bubble-primary
                    {% endif %}">
          {% if msg.message_type == "text" and not msg.file %}
            {{ msg.content }}
          {% elif msg.message_type == "image" and msg.file %}
            <a href="{% url 'file_download' msg.file.id %}" target="_blank" class="block">
              <img src="{% url 'file_download' msg.file.id %}"
                   alt="{{ msg.file.filename }}"
                   class="max-w-xs rounded-lg">
            </a>
            {% if msg.content %}
              <div class="mt-1 text-xs opacity-80">{{ msg.content }}</div>
            {% endif %}
          {% elif msg.message_type == "document" and msg.file %}
            <a href="{% url 'file_download' msg.file.id %}" target="_blank"
               class="flex items-center gap-2">
              üìé <span class="underline text-xs break-all">
                {{ msg.file.filename|default:"–§–∞–π–ª" }}
              </span>
            </a>
            {% if msg.content %}
              <div class="mt-1 text-xs opacity-80">{{ msg.content }}</div>
            {% endif %}
          {% else %}
            {{ msg.content }}
          {% endif %}
        </div>

        <div class="chat-footer text-[10px] text-base-content/60">
          {{ msg.created_at|date:"d.m H:i" }}
        </div>
      </div>
  {% empty %}
    <div class="text-xs text-base-content/60">
      –°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç. –ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É.
    </div>
  {% endfor %}
</div>

<!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
<div class="border-t border-base-200 p-3">
  <form
    id="telegram-chat-send-form"
    hx-post="{% url 'telegram_send_message' client.id %}"
    hx-target="#telegram-chat-panel"
    hx-swap="innerHTML show:bottom"
    enctype="multipart/form-data"
    class="flex flex-col gap-2"
  >
    {% csrf_token %}

    <!-- —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ -->
    <input type="hidden" name="content" id="tg_hidden_content">

    <!-- –°—Ç—Ä–æ–∫–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –∏ –ø–æ–ª–µ–º -->
    <div class="flex items-end gap-2">
      <label class="btn btn-sm btn-ghost" for="tg_file_input">
        <svg xmlns="http://www.w3.org/2000/svg"
             viewBox="0 0 24 24"
             fill="none"
             stroke="currentColor"
             stroke-width="1.5"
             class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M18.375 12.375 13.5 17.25a4.125 4.125 0 1 1-5.835-5.835l6.364-6.364a2.875 2.875 0 1 1 4.065 4.065L11.25 18.75" />
        </svg>
      </label>
      <input id="tg_file_input" type="file" name="file" class="hidden">

      <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
      <div
        id="tg_message_input"
        class="flex-1 max-h-32 min-h-[3.5rem] px-3 py-2 rounded-lg bg-base-100 text-sm overflow-y-auto outline-none border border-siriBorder focus:border-siriBorderDark"
        contenteditable="true"
        data-placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
        onkeydown="handleChatInputKey(event)"
      ></div>

      <!-- –ö–Ω–æ–ø–∫–∞ —ç–º–æ–¥–∑–∏ -->
      <button
        type="button"
        id="tg_emoji_button"
        class="btn btn-sm btn-ghost text-lg"
        onclick="toggleEmojiPicker()"
      >
        üòä
      </button>

      <!-- –ü–æ–ø–æ–≤–µ—Ä‚Äë–ø–∏–∫–µ—Ä -->
      <div
        id="tg_emoji_popover"
        class="hidden absolute bottom-12 right-20 z-50 w-64 max-h-64 rounded-lg border border-base-300 bg-base-100 shadow-lg p-2 overflow-y-auto"
      >
        <div class="text-xs text-base-content/60 px-1 mb-1">–≠–º–æ–¥–∑–∏</div>
        <div class="emoji-grid grid grid-cols-8 gap-1 text-xl leading-none"></div>
      </div>

      <!-- –û—Ç–ø—Ä–∞–≤–∫–∞ (—Å–∞–º–æ–ª—ë—Ç–∏–∫) -->
      <button type="submit" class="btn btn-sm btn-primary px-3">
        <svg xmlns="http://www.w3.org/2000/svg"
             class="w-4 h-4"
             fill="none"
             viewBox="0 0 24 24"
             stroke="currentColor"
             stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M5 12l14-7-4 14-3-5-5-2z" />
        </svg>
      </button>
    </div>

    <!-- –ë–µ–π–¥–∂ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ -->
    <div id="tg_file_badge" class="hidden text-xs">
      <div class="inline-flex items-center gap-2 px-2 py-1 rounded bg-base-200 text-base-content/80">
        <span class="truncate max-w-[220px]" id="tg_file_name"></span>
        <button type="button" class="btn btn-xs btn-ghost px-1" onclick="clearSelectedFile()">
          ‚úï
        </button>
      </div>
    </div>
  </form>
</div>

<script>
  // –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–∞–Ω–µ–ª–∏ —á–∞—Ç–∞
  (function () {
    const box = document.getElementById('telegram-chat-messages');
    if (box) {
      box.scrollTop = box.scrollHeight;
    }
  })();

  // –ø–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
  document.addEventListener('change', (e) => {
    if (e.target && e.target.id === 'tg_file_input') {
      const input = e.target;
      const badge = document.getElementById('tg_file_badge');
      const nameEl = document.getElementById('tg_file_name');

      if (input.files && input.files.length > 0) {
        const file = input.files[0];
        nameEl.textContent = file.name;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
        nameEl.textContent = '';
      }
    }
  });

  function clearSelectedFile() {
    const input = document.getElementById('tg_file_input');
    const badge = document.getElementById('tg_file_badge');
    const nameEl = document.getElementById('tg_file_name');

    if (!input) return;

    input.value = '';
    badge.classList.add('hidden');
    nameEl.textContent = '';
  }

  // —Ä–∞–±–æ—Ç–∞ —Å —Ç–µ–∫—Å—Ç–æ–º

  function getMessageText() {
  const el = document.getElementById('tg_message_input');
  if (!el) return '';

  // –ë–µ—Ä—ë–º HTML –∏ –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
  let html = el.innerHTML;

  // <br> -> \n
  html = html.replace(/<br\s*\/?>/gi, '\n');            // [web:1857]

  // –±–ª–æ–∫–∏ <div> / <p> -> –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
  html = html.replace(/<\/(div|p)>/gi, '\n');           // [web:1861]

  // —É–±–∏—Ä–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏
  html = html.replace(/<[^>]+>/g, '');

  // –∑–∞–º–µ–Ω—è–µ–º &nbsp; –Ω–∞ –æ–±—ã—á–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã
  html = html.replace(/&nbsp;/gi, ' ');

  return html.trim();
}

  function clearMessageInput() {
    const box = document.getElementById('tg_message_input');
    const hidden = document.getElementById('tg_hidden_content');
    if (box) box.innerHTML = '';
    if (hidden) hidden.value = '';
  }

  // Enter = –æ—Ç–ø—Ä–∞–≤–∫–∞, Shift+Enter = –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
  function handleChatInputKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      const form = e.target.closest('form');
      if (!form) return;

      const text = getMessageText();
      const hidden = document.getElementById('tg_hidden_content');
      if (hidden) hidden.value = text;

      form.requestSubmit(); // –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π submit, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç htmx[web:1842][web:1666]
      }
  }

  // –ü—Ä–∏ –∫–ª–∏–∫–µ –ø–æ –∫–Ω–æ–ø–∫–µ —Å–∞–º–æ–ª—ë—Ç–∏–∫–∞ —Ç–æ–∂–µ –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –≤ hidden
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('#telegram-chat-send-form button[type="submit"]');
    if (!btn) return;

    const form = btn.form;
    if (!form) return;

    const text = getMessageText();
    const hidden = document.getElementById('tg_hidden_content');
    if (hidden) hidden.value = text;
  });
</script>
